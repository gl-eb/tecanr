---
title: "Using tecanr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using tecanr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette illustrates how the two high-level functions in the `tecanr` package can be used in analysis workflows.
While the thematic focus of this vignette is microbiology, there is no reason why the same principles could not be applied to another field that makes use of plate readers.

```{r setup}
library(tecanr)
```


# Reading and Plotting of OD Values

First we will import the optical density measurements from the xlsx file using `tecan_parse()`
The file we are using contains OD measurements of a 96-well plate with a single timepoint but multiple measurements per well.

```{r OD-data-import}
# get path to Excel file
file_OD <- system.file(
  "extdata",
  "tecan_single_time_multiple_reads.xlsx",
  package = "tecanr"
)

# read data from file
dat_OD <- file_OD |> tecan_parse()
```

The table we get back from `tecan_parse()` contains the four OD measurements for each well in addition to their mean and standard deviation.
It's important to note that while this data set contains measurements of all wells of a 96-well plate, `tecanr`'s functions can import data for any number of measured wells.

```{r OD-results}
dat_OD
```

We can now plot this data, e.g. using `ggplate::plate_plot()`.

```{r plate-plot}
library(ggplate)

dat_OD |> plate_plot(
  position = well,
  value = mean,
  plate_size = 96,
  plate_type = "round"
)
```

We can also add additional information to the table, e.g. which wells contain particular becterial strains and which liquid medium only.

```{r OD-metadata}
# we create a table that describes the content of each well
well_annotation <- tibble::tibble(
  well = dat_OD$well,
  content = c(
    "buffer", "buffer", "buffer", "buffer", "buffer", "buffer", "buffer",
    "buffer", "buffer", "buffer", "buffer", "buffer", "A1", "buffer", "A3",
    "buffer", "D1", "buffer", "D3", "buffer", "G1", "buffer", "G3",
    "buffer", "buffer", "A2", "buffer", "A4", "buffer", "D2", "buffer",
    "D4", "buffer", "G2", "buffer", "medium", "B1", "buffer", "B3",
    "buffer", "E1", "buffer", "E3", "buffer", "H1", "buffer", "H3",
    "buffer", "buffer", "B2", "buffer", "B4", "buffer", "E2", "buffer",
    "E4", "buffer", "H2", "buffer", "medium", "C1", "buffer", "C3",
    "buffer", "F1", "buffer", "F3", "buffer", "J1", "buffer", "J3",
    "buffer", "buffer", "C2", "buffer", "C4", "buffer", "F2", "buffer",
    "F4", "buffer", "J2", "buffer", "medium", "buffer", "buffer",
    "buffer", "buffer", "buffer", "buffer", "buffer", "buffer", "buffer",
    "buffer", "buffer", "buffer"
  )
)

# we join the annotation table to the OD table
dat_OD <- dat_OD |>
  dplyr::left_join(well_annotation, by = dplyr::join_by("well")) |>
  dplyr::relocate("content", .after = "well")

dat_OD
```

Having medium-only wells allows us to blank the measurements.

```{r OD-blank}
# first we calculate the blanking value from the average of medium-only wells
blank <- dat_OD |>
  dplyr::filter(content == "medium") |>
  dplyr::pull(mean) |>
  mean()

# then we substract the blanking value from all OD values
# (mean and all four reading from each well)
dat_OD <- dat_OD |>
  dplyr::mutate(
    dplyr::across(
      c("mean", tidyselect::starts_with("x")),
      ~ .x - blank
    )
  )

dat_OD
```

Finally, we can filter out any wells that do not contain bacteria and plot their blanked OD values.

```{r OD-plot}
library(ggplot2)
library(ggbeeswarm)

# filter out well that do not contain bacteria and separate the population name
# into the strain name and the replicate number
dat_OD <- dat_OD |>
  dplyr::filter(content != "buffer" & content != "medium") |>
  tidyr::separate("content", into = c("strain", "replicate"), sep = 1)

dat_OD

# we plot the blanked OD values grouped by the letter of the strain name
dat_OD |> ggplot(aes(x = strain, mean, fill = replicate)) +
geom_hline(yintercept = 0, linetype = 2, alpha = 0.5) +
geom_beeswarm(cex = 2.5, size = 3, color = "black", shape = 21) +
scale_fill_viridis_d() +
labs(
  x = "Population",
  y = bquote("Bacterial Density ("*OD[600]*")"),
  colour = "Replicate"
) +
theme_light(15)
```


# Joining Multiple Pieces and Plotting of a Growth Curve

```{r example-data-multi}
# read supplied example file of a time series of measurements where the plate
# reader program was stopped and restarted, resulting in the data being split
# into multiple segments / sheets
tecan_unite(
  system.file(
    "extdata",
    "tecan_time_series_segments.xlsx",
    package = "tecanr"
  )
)
```
